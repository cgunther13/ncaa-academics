---
title: "Taxi Final Report"
author: "Christoph, Chris, Carol"
date: "4/30/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction - 2015 Yellow Taxi Trip Data - NYC Open Data
https://data.cityofnewyork.us/Transportation/2015-Yellow-Taxi-Trip-Data/ba8s-jw6u

"This dataset includes trip records from all trips completed in yellow taxis 
in NYC from January to June in 2015.  Records include fields capturing pick-up 
and drop-off dates/times, pick-up and drop-off locations, trip distances, 
itemized fares, rate types, payment types, and driver-reported passenger counts. 
The data used in the attached datasets were collected and provided to the NYC 
Taxi and Limousine Commission (TLC) by technology providers authorized under the 
Taxicab Passenger Enhancement Program (TPEP). The trip data was not created by 
the TLC, and TLC makes no representations as to the accuracy of these data." 
(from NYC Open Data)

This dataset is huge (146,087,462 rows and 5GB), and too big for our computers 
to work with, so we decided to load in data for 1 day. We chose May 6, for no 
reason in partiocular, except that it is a non-holiday weekday. This was still
a huge amount of data however, so we filtered it further by selecting only the 
rides where passengers paid with a credit card (because these are the only rides
with tip data, which we are interested in exploring), and then took a random 10%
of the rides.

## Research Questions
We are particularly interested in exploring 3 features of this taxi trips 
dataset: time (`dropoff_datetime` and `pickup_datetime`), location 
(`dropoff_latitude`, `dropoff_longitude`, `pickup_latitude`, and
`pickup_longitude`), and payments, specifically tips (`tip_amount`). 

  * How do riders tip?
    * Standard percentage (ie: always 20%), round to the nearest dollar (ie: 
    $1.57 tip on a $4.43 bill), whole dollar tip (ie: $2)?
    * Which variables most affect tipping behavior?
  * What are the most popular pickup and drop off locations in New York and at 
    what times are they most popular? 
    * In addition, to answer this question from a slightly different 
    perspective, we'll look at which directions are taxis traveling at different 
    times of the day? 

## Data
* `avg_speed`: average speed of the taxi during the trip in mph
* `cent_pickup`: how far the pickup site is from the city center
* `cent_dropoff`: how far the dropoff site is from the city center
* `dropoff_datetime`: date and time when meter was disengaged
* `dropoff_hour`: hour of the day when the meter was disengaged
* `dropoff_latitude`: latitude where the meter was disengaged
* `dropoff_longitude`: longitude where the meter was disengaged
* `dropoff_region`: region where the meter was disenaged (one of 25 regions into 
                    which we divided NYC)
* `dropoff_time`: time of day when meter was disengaged (either morning, 
                  afternoon, evening, or night)
* `extra`: Miscellaneous extras and surcharges (0 = no charge, 0.5 = $0.50 rush 
           hour charge, 1 = $1 overnight charge)
* `fare_amount`: time-and-distance fare calculated by the meter
* `imp_surcharge`: 
* `mta_tax`: $0.50 tax on taxi rides   
* `outbound`: 1 if the ride moves away from downtown Manhattan, 0 otherwise
* `passenger_count`: number of passengers in the vehicle
* `payment_type`: how the passenger paid for the trip. Always 1 (credit 
                  card) in the subset of the data we are analyzing
* `pickup_datetime`: date and time when meter was engaged 
* `pickup_hour`: hour of the day when the meter was engaged
* `pickup_latitude`: latitude where the meter was engaged   
* `pickup_longitude`: longitude where the meter was engaged   
* `pickup_region`: region where the meter was enaged (one of 25 regions into 
                   which we divided NYC)
* `pickup_time`: time of day when meter was engaged (either morning, afternoon,
                 evening, or night)
* `rate_code`: final destination (1 = Standard rate, 2 = JFK, 3 = Newark 4 = 
               Nassau or Westchester, 5 = Negotiated Fare, 6 = Group Ride)       
* `store_and_fwd_flag`: whether the trip record was held in vehicle memory 
                        before sending to the vendor
* `tip_amount`: tip paid. Note: Only calculated for credit card tips   
* `tip_pct` - tip as a percentage of total fee (fare + tolls + extra + mta_tax)
* `tolls_amount`: total amount of all tolls paid in the trip
* `total_amount`: total amount charged to passengers (fare + tip + tolls + 
                  extra + mta_tax)
* `trip_distance`: elapsed trip distance in miles
* `trip_duration`: length of time, in minutes, that the meter was engaged
* `vendor_id`: technology vendor that provided the record (1 = Creative Mobile 
               Technologies, 2 = VeriFone)
  
```{r, echo=FALSE}
taxi <- read.csv("taxi_data.csv", as.is = TRUE)
```

```{r, echo = FALSE, meassage = FALSE, warning = FALSE, include = FALSE}
library(dplyr)
library(ggplot2)
library(ggmap)
library(grid)
library(gridExtra)
library(knitr)
library(leaps)
library(lubridate)
library(mapproj)
library(MASS)
library(pander)
```


```{r, echo=FALSE}
# Add imp_surcharge
taxi$imp_surcharge <- rep(0.3, nrow(taxi))
```

```{r, echo=FALSE}
# Create `tip_pct`
taxi <- taxi %>% mutate(tip_pct = (tip_amount / (total_amount - tip_amount)) * 100)

# Remove observation where tip_pct > 100
taxi <- taxi[taxi$tip_pct <= 100,]
```

```{r, echo=FALSE}
# Create `pickup_hour` and `dropoff_hour`
taxi$pickup_hour <- as.numeric(substr(taxi$pickup_datetime, 12, 13))
taxi$dropoff_hour <- as.numeric(substr(taxi$dropoff_datetime, 12, 13))

# Create `pickup_time` and `dropoff_time`
taxi$pickup_time <- factor(ifelse(taxi$pickup_hour %in% 6:11, "Morning", 
                    ifelse(taxi$pickup_hour %in% 12:17, "Afternoon", 
                    ifelse(taxi$pickup_hour %in% 18:23, "Evening",
                    ifelse(taxi$pickup_hour %in% 0:5, "Night", NA)))), 
                    levels = c("Morning", "Afternoon", "Evening", "Night"))
taxi$dropoff_time <- factor(ifelse(taxi$dropoff_hour %in% 6:11, "Morning", 
                     ifelse(taxi$dropoff_hour %in% 12:17, "Afternoon", 
                     ifelse(taxi$dropoff_hour %in% 18:23, "Evening",
                     ifelse(taxi$dropoff_hour %in% 0:5, "Night", NA)))),
                     levels = c("Morning", "Afternoon", "Evening", "Night"))
```

```{r, echo=FALSE}
# Only consider longitudes and latitudes in Manhatten
MAXLAT <- 40.85; MINLAT <- 40.675; MAXLONG <- -73.85; MINLONG <- -74.1
taxi <- taxi %>% filter(pickup_longitude < MAXLONG, pickup_longitude > MINLONG, 
               pickup_latitude < MAXLAT, pickup_latitude > MINLAT)
taxi <- taxi %>% filter(dropoff_longitude < MAXLONG, dropoff_longitude > MINLONG, 
               dropoff_latitude < MAXLAT, dropoff_latitude > MINLAT)

# Remove rows where dropoff = pickup
taxi <- taxi %>% filter(dropoff_longitude != pickup_longitude, 
              dropoff_latitude != pickup_latitude) 
```

```{r, echo=FALSE}
# Create geographic regions 
taxi$dropoff_lat_region <- cut(taxi$dropoff_latitude, 3)
taxi$dropoff_long_region <- cut(taxi$dropoff_longitude, 3)
taxi$pickup_lat_region <- cut(taxi$pickup_latitude, 3)
taxi$pickup_long_region <- cut(taxi$pickup_longitude, 3)

taxi$pickup_region <- as.factor(3 * as.numeric(taxi$pickup_lat_region) + 
                                    as.numeric(taxi$pickup_long_region) - 3)
taxi$dropoff_region <- as.factor(3 * as.numeric(taxi$dropoff_lat_region) +
                                     as.numeric(taxi$dropoff_long_region) - 3)
```

```{r, echo=FALSE}
# Create outbound, cent_pickup, and cent_dropoff
norm <- function(x) {
sqrt(rowSums(x^2))
}

# Coordinates of Bryant Park taken as Downtown Manhattan
cent_lat <- 40.753889
cent_long <- -73.983490 

cent_pickup <- data.frame(x = rep(cent_lat,nrow(taxi)) - taxi$pickup_latitude, 
                          y = rep(cent_long, nrow(taxi)) - taxi$pickup_longitude)
cent_dropoff <- data.frame(x = rep(cent_lat,nrow(taxi)) - taxi$dropoff_latitude, 
                           y = rep(cent_long, nrow(taxi)) - taxi$dropoff_longitude)

taxi$cent_pickup <- norm(cent_pickup)
taxi$cent_dropoff <- norm(cent_dropoff)
taxi$outbound <- as.numeric(norm(cent_dropoff) > norm(cent_pickup))
```

```{r, echo=FALSE}
# Remove `trip_distance` = 0
taxi <- taxi[taxi$trip_distance > 0,]
```

```{r, echo=FALSE}
# Remove `passenger_count` = 0
taxi <- taxi[taxi$passenger_count > 0,]
```

```{r, echo=FALSE}
# Create `trip_duration`
taxi$pickup_datetime <- ymd_hms(taxi$pickup_datetime)
taxi$dropoff_datetime <- ymd_hms(taxi$dropoff_datetime)
taxi$trip_duration <- as.numeric((taxi$dropoff_datetime - taxi$pickup_datetime) / 60)
taxi <- taxi[taxi$trip_duration > 0,]
```

```{r, echo=FALSE}
# Create `avg_speed`
taxi$avg_speed <- taxi$trip_distance / (taxi$trip_duration / 60)
```

```{r, echo=FALSE}
# Produces heat plot of NYC showing average of desired variable for each region. 
  # data: data frame from which data is drawn
  # variable: vector of the variable under consideration
  # lat_type: either "pickup" or "dropoff"
  # GRID_RESOLUTION: integer representing number of divisions of longitude/latitude
  # title: string containing plot title
  # varname: string containing variable name
  # MINLAT, MAXLAT, MINLONG, MAXLONG: specify area covered by plot

locationPlot <- function(data, variable, lat_type = "pickup", GRID_RESOLUTION = 100, 
                         title = "Add Title", varname = "Variable", MINLAT = 40.675, 
                         MAXLAT = 40.85, MINLONG = -74.1, MAXLONG = -73.85) {
  
  data$variable <- variable
    
  if(lat_type == "pickup") {
    # Select all taxi rides whose pickup was within specified region. Stores 
    # these rides to a new data frame 'pos'
    pos <- filter(data, pickup_longitude < MAXLONG, pickup_longitude > MINLONG, 
                  pickup_latitude < MAXLAT, pickup_latitude > MINLAT) 
    # Remove all rows with dropoff longitude or latitude equal to 0
    pos <- filter(pos, dropoff_longitude != 0, dropoff_latitude!= 0) 
    # Remove all rows where pickup and dropoff locations are the same
    pos <- filter(pos, dropoff_longitude != pickup_longitude, 
                  dropoff_latitude != pickup_latitude) 
    # Cut latitude into bins
    pos$lat_region <- cut(pos$pickup_latitude,GRID_RESOLUTION) 
    # Cut longitude into bins
    pos$long_region <- cut(pos$pickup_longitude,GRID_RESOLUTION) 
  } 
  
  else if (lat_type == "dropoff") {
    pos <- filter(data, dropoff_longitude < MAXLONG, dropoff_longitude > MINLONG, 
                  dropoff_latitude < MAXLAT, dropoff_latitude > MINLAT) 
    pos <- filter(pos, dropoff_longitude != 0, dropoff_latitude!= 0) 
    pos <- filter(pos, dropoff_longitude != pickup_longitude, dropoff_latitude != pickup_latitude)
    pos$lat_region <- cut(pos$dropoff_latitude,GRID_RESOLUTION)
    pos$long_region <- cut(pos$dropoff_longitude,GRID_RESOLUTION)
  }
  
  # Groups data in 'pos' by 'lat_region' and 'long_region' (region on the grid) 
  # Calculates number of rides being picked up in each region ('count') and the 
  # average direction traveled for each taxi rides beginning in each grid 
  # (long_dir_avg, lat_dir_avg)
  grouped <- group_by(pos, lat_region, long_region) %>% 
    summarize(count = n(), var = mean(variable)) 

  temp <-  grouped$lat_region
  temp <- gsub("\\(", "", temp)
  temp <- gsub("\\]", "", temp)
  temp <- strsplit(temp, ",")
  temp <- unlist(temp)
  temp <- as.numeric(temp)
  grouped$max_lat <- temp[2*1:nrow(grouped)] # list of latitude upper bounds
  grouped$min_lat <- temp[2*1:nrow(grouped)-1] # listof latitude lower bounds
  grouped$avg_lat <- 0.5*(grouped$max_lat + grouped$min_lat)
  
  temp <-  grouped$long_region
  temp <- gsub("\\(", "", temp)
  temp <- gsub("\\]", "", temp)
  temp <- strsplit(temp, ",")
  temp <- unlist(temp)
  temp <- as.numeric(temp)
  grouped$max_long <- temp[2*1:nrow(grouped)] # list of longitude upper bounds
  grouped$min_long <- temp[2*1:nrow(grouped)-1] # listof longitude lower bounds
  grouped$avg_long <- 0.5*(grouped$max_long + grouped$min_long)
  
  # Load Google Map of desired region
  map <- get_map(location = c(MINLONG,MINLAT, MAXLONG, MAXLAT), source = "stamen", 
                 maptype = "watercolor") 
  
  ggmap(map) + 
    geom_rect(aes(x = min_long, y = max_long, xmin = min_long, xmax = max_long, 
                  ymin = min_lat, ymax = max_lat, fill = var), data = grouped) + 
    scale_fill_gradientn(varname, colors = c("purple","blue","green","yellow","orange","red")) + 
    labs(title = title, x = expression(italic("Longitude") ~ "(degrees)"), y = 
           expression(italic("Latitude") ~ "(degrees)"))
}
```

```{r, eval=FALSE, echo=FALSE}
# plot(taxi[,c(7,15,16,17,19,20,21,30,31)])
```





















**1) What factors predict how much (as a percentage of their total fare) a person tips?**


#Cut into short trips and long rides


* Do people tip more, as a percentage, if their fare is lower?

```{r, echo=FALSE}
ggplot(subset(taxi, total_amount < 50), aes(x = total_amount - tip_amount, y = tip_pct)) + 
  geom_point() + 
  geom_smooth() +
  labs(title = "Percentage Tipped by Total Amount", 
       x = "Total Amount (not including tip) ($)", y = "Percentage Tipped")

mfare <- lm(tip_pct ~ fare_amount, data = taxi)
summary(mfare)
```

For our first attempt to explain `tip_pct`, we decided to use `fare_amount` as a
predictor. We hypothesized that people would give larger tips, in percent terms, 
the smaller their fare amount since these tips on small amounts are smaller in 
absolute terms. For example, it would not be uncommon for someone to give a 40% 
tip on a 5 dollar fare, because that only amounts to 2 dollars, but a 40% tip on 
a 30 dollar fare (12 dollars) would be less likely. 

The data do lend some support to this hypothesis, as most of the high percentage 
tips are given on lower bills, and there is a downward curving pattern to the 
data points, and the coefficient of `fare_amount` is negative, though small 
(-0.062), and highly signifcant. 

More interestingly, however, are other patterns that appear in the data.

First, you can see the ubiquitousness of standard tip amounts in the horizantal 
line of points at 20%, 25%, and 30%. About 25% of riders tip approximately 20%, 
while another 5% tip 25% and 2% tip 30%. We decided to remove these tip 
percentages for our further analysis, because the riders tipping these salient 
amounts are most likely choosing tips regardless of the other variables, and our 
goal is to explore how these other factors affect `tip_pct`. Further, there is 
another row of points at 0%. We decided to remove these observations, about 3% 
of the data, for the same reason, and because these riders could have tipped in 
cash, which we cannot determine from the data we have.

```{r, echo=FALSE}
taxi2 <- taxi
taxi2 <- taxi2[round(taxi2$tip_pct) != 0,]
taxi2 <- taxi2[round(taxi2$tip_pct) != 20,]
taxi2 <- taxi2[round(taxi2$tip_pct) != 25,]
taxi2 <- taxi2[round(taxi2$tip_pct) != 30,]

# set.seed(230)
# taxi2$tip_pct[round(taxi2$tip_pct) == 20] <- 20 + 
#   rnorm(sum(round(taxi2$tip_pct) == 20))
# taxi2$tip_pct[round(taxi2$tip_pct) == 25] <- 25 + 
#   rnorm(sum(round(taxi2$tip_pct) == 25))
# taxi2$tip_pct[round(taxi2$tip_pct) == 30] <- 30 + 
#   rnorm(sum(round(taxi2$tip_pct) == 30))
```

Moreover, in this plot we also see interesting, downward sloping, convex lines 
of points. These are due to people giving whole dollar tips, as seen in the 
following plots:

```{r, echo=FALSE}
rounded <- taxi2[taxi2$tip_amount %% 1 == 0,]
for(i in 0:5) {
  whole_num <- function(x) {(((x + i)/x) - 1) * 100}
  print(ggplot(rounded, aes(total_amount - tip_amount, tip_pct)) +
    geom_jitter() +
    stat_function(fun = whole_num) + 
    labs(title = "Percentage Tipped by Total Amount for Whole Dollar Tips", 
         x = "Total Amount (not including tip) ($)", y = "Percentage Tipped"))
}
```


*****QUESTION FOR CHRISTOPH*****

We subsetted the data to only include whole dollar tip amounts, so the points 
show the `tip_pct` and total bill minus tip for rides with whole dollar tips. 
The overlaid lines represent who tipped whole dollar amounts (nearly 25% of 
the original dataset), and the overlaid lines....

```{r}
# round_up <- taxi2[taxi2$total_amount %% 1 == 0,]
# for(i in 0:5) {
#   whole_num <- function(x) {(((ceiling(x) + i) / x) - 1) * 100}
#   print(ggplot(rounded, aes(total_amount, tip_pct)) +
#     geom_jitter() +
#     stat_function(fun = whole_num) + 
#     labs(title = "Percentage Tipped by Total Amount for Whole Dollar Tips", 
#          x = "Total Amount (not including tip) ($)", y = "Percentage Tipped"))
# }
```

So, we decided to remove these observations as well, for the same reason we 
decided to remove the standard tip amounts. We can already explain this tipping
behavior, and in fact have a model that fits the points perfectly. Therefore, it
wll be more interesting to focus our analysis on the points we haven't yet 
explained.

```{r, echo=FALSE}
taxi3 <- taxi2[taxi2$tip_amount %% 1 != 0,]
```

Now we can continue with our analysis. 

```{r, echo=FALSE}
ggplot(subset(taxi3, total_amount < 50), aes(x = total_amount - tip_amount, y = tip_pct)) + 
  geom_point() + 
  geom_smooth() +
  labs(title = "Percentage Tipped by Total Amount", 
       x = "Total Amount (not including tip) ($)", y = "Percentage Tipped")

mfare2 <- lm(tip_pct ~ fare_amount, data = taxi3)
summary(mfare2)
```

```{r, echo=FALSE}
mfare3 <- lm(tip_pct ~ fare_amount + I(fare_amount^2), data = taxi2)
summary(mfare3)
```

After removing these observations, the coefficient on `fare_amount` drops from 
-0.062 to -0.297, and stays highly significant, even with much fewer 
observations. So we now expect a 1 dollar increase in fare to be associated with 
a 0.3% smaller tip. Moreover, the $R^2$ of this new model jumps from 0.5% to 
6.7%. Finally, if we add a squared term for `fare_amount`, since it appears that 
the regression line plateaus and even increases slightly after 20 dollars, the 
coefficient drops further to -0.810, the coefficient on `fare_amount` squared is
significant, and the $R^2$ rises further to 8.4%. In context, this means that 
tips, percent wise, are highest at low fares, drop slightly as the fare 
increases for a while, and then rise back up.


* Do people tip more if the taxi drives more quickly?

```{r, fig.width = 2.5, fig.height= 2}
ggplot(subset(taxi3, tip_pct <= 50), aes(x = avg_speed, y = tip_pct)) + 
  geom_point() +
  geom_smooth() + 
  labs(title = "Tip % by Avg Speed", x = "Average Speed (mph)", 
       y = "Percentage Tipped")
```

```{r, echo=FALSE}
mspeed <- lm(tip_pct ~ avg_speed, data = taxi3)
summary(mspeed)
```

Moving on, we next decided to test if our hypothesis that people would tip more 
the higher the average taxi speed, because people generally don't like waiting 
in traffic, so if they get to where they are going more quickly, relative to how 
far they are traveling, they would give a higher tip to thank the driver. 
However the model gives a very small, not very significant coefficient on 
`avg_speed` and the scatterplot shows almost no correlation. Perhaps some people
tip less the faster they go because they feel unsafe manuevering quickly through
NYC traffic. If this is true, it could offset our hypothesis and result in this
overall lack of correlation.


* Do people tip more if there are more passengers in the car? 

```{r, fig.width = 3, fig.height= 2}
ggplot(taxi3, aes(x = factor(passenger_count), y = tip_pct)) + 
  geom_boxplot() + 
  labs(title = "Tip % by # of Passengers", x = "Number of Passengers", 
       y = "Percentage Tipped")
```

```{r, echo=FALSE}
mpassengers <- lm(tip_pct ~ passenger_count, data = taxi3)
summary(mpassengers)
anova(mpassengers)
pairwise.t.test(taxi$tip_pct, taxi$passenger_count)
```

```{r, echo=FALSE}
mpassengers <- lm(tip_pct ~ passenger_count + I(passenger_count^2), data = taxi3)
summary(mpassengers)
anova(mpassengers)
```

Here, our hypothesis was that riders would tip more as the number of passengers 
increased, due to a social pressure exerted from the other passengers to tip 
more. However, the boxplot shows that all riders tip the same (median of 20%) 
regardless of how many people were in the car. Further, the regression gives a
small, negative coefficient on `passenger_count`, and it is not very significant. 
Finally, the pairwise t-test shows that no two levels of `passenger_count` are 
different from one another.


* Do people tip more at different times of day?

```{r, echo=FALSE}
ggplot(taxi[taxi$tip_pct < 50,], aes(x = dropoff_time, y = tip_pct)) + 
  geom_boxplot() + 
  labs(title = "Percentage Tipped by Time of Day", x = "Time of Day", 
       y = "Percentage Tipped")
```

```{r, echo=FALSE}
mdropoff_time <- lm(tip_pct ~ dropoff_time, data = taxi3)
summary(mdropoff_time)
anova(mdropoff_time)
pairwise.t.test(taxi$tip_pct, taxi$dropoff_time)

mpickup_time <- lm(tip_pct ~ pickup_time, data = taxi3)
summary(mpickup_time)
anova(mpickup_time)
pairwise.t.test(taxi$tip_pct, taxi$pickup_time)

mtime <- lm(tip_pct ~ dropoff_time + pickup_time, data = taxi3)
summary(mtime)
anova(mpickup_time)
```

```{r, echo=FALSE}
ggplot(taxi3, aes(x = pickup_hour, y = tip_pct)) +
  geom_jitter() +
  labs(title = "Percentage Tipped by Time of Day", x = "Time of Day",
       y = "Percentage Tipped")
```

Next, we looked at how tip giving bahvior changes throughout the day. 
In terms of `dropoff_time`, the p-values were not significant, but, looking at 
the pairwise t-test, we see that Night is significantly different from Morning, 
Afternoon, and Evening at the 0.05 significance level. No other levels are 
signifcantly different. Thus, since the coefficient on Night from the regression 
summary is negative (-0.576), we conclude that the data suggest that riders tip 
less, percent wise, at night (midnight to 5 AM) we see that tips at Night 
(midnight to 5 AM). This result makes sense because people riding that late are
most likely tired and more likely to get mad at a driver, and thus tip less (if
we assume people are worse at controlling their emotions when they are tired.)

Note: We get a similar result for `pickup_time`, and for a combined 
regression with both `pickup_time` and `drop_off` time.

* Do people tip more in different areas?

```{r, echo=FALSE}
# mpickup_lat <- lm(tip_pct ~ pickup_lat_region, data = taxi)
# summary(mpickup_lat)
# mpickup_long <- lm(tip_pct ~ pickup_long_region, data = taxi)
# summary(mpickup_long)
# mdropoff_lat <- lm(tip_pct ~ dropoff_lat_region, data = taxi)
# summary(mdropoff_lat)
# mdropoff_long <- lm(tip_pct ~ dropoff_long_region, data = taxi)
# summary(mdropoff_long)
# 
# mlat <- lm(tip_pct ~ pickup_lat_region + dropoff_lat_region, data = taxi)
# summary(mlat)
# mlong <- lm(tip_pct ~ pickup_long_region + dropoff_long_region, data = taxi)
# summary(mlong)

mpickup_region <- lm(tip_pct ~ factor(pickup_region), data = taxi3)
summary(mpickup_region)
anova(mpickup_region)

mdropoff_region <- lm(tip_pct ~ factor(dropoff_region), data = taxi3)
summary(mdropoff_region)
anova(mdropoff_region)
```

```{r}
pickup_region <- taxi3 %>% group_by(pickup_region) %>%
  summarize(count = n(), var = mean(tip_pct))
dropoff_region <- taxi3 %>% group_by(dropoff_region) %>%
  summarize(count = n(), var = mean(tip_pct))
```

```{r, message=FALSE, warning=FALSE, fig.width = 3, fig.height= 3}
locationPlot(taxi3, taxi3$tip_pct, lat_type = "pickup", GRID_RESOLUTION = 3, 
             title = "Percentage Tipped by Time of Day", varname = "TipPct") 
            
locationPlot(taxi3, taxi3$tip_pct, lat_type = "dropoff", GRID_RESOLUTION = 3, 
             title = "Percentage Tipped by Time of Day", varname = "TipPct")
```

Finally, we looked at how tipping behavior changes in different regions of NYC. 
From the regression summary, we can see that tipping is highest in region 7, 
which is northern New Jersey, but that is due to the fact that only 1 trip 
dropped off there, and the rider tipped 0%. The higher tips in region 6 
(Queens), and region 8 (The Bronx) seem more significant however, as the 773 and 
1472 riders dropped off in those areas tipped about 1% more, and 0.9% less, 
respectively, on average as compared to region 1 (lower Manhatten) and the rest 
of NYC (since most regions are not significantly different from region 1). We 
see the same result when looking at tips based on `pickup_region`.


* Which variables are most important for predicting `tip_pct`. All-subsets 
regression 

We only incuded a subset of the variables in the all subsets regression. We 
eliminated some predictors (ie: `vendor_id`, `store_and_fwd_flag`, `rate_code`) 
because the rider did not know them and they could not have affected `tip_pct`, 
others (ie: `payment_type`, `mta_tax`, `imp_surcharge`) because they were the 
same for every ride, others because they were obviously correlated with other 
predictors or `tip_pct` itself (ie: `tip_amount` with `tip_pct`, `trip_duration` 
with `trip_distance`, `total_amount` with `fare_amount`, `pickup_time`, 
`pickup_hour`, `pickup_datetime`, `dropoff_hour`, `dropoff_datetime` with 
`dropoff_time`, and `pickup_region`, `dropoff_latitude`, `dropoff_longitude`, 
`pickup_latitude`, `pickup_longitude` with `dropoff_region`). That leaves 9
predictors: `extra`, `fare_amount`, `passenger_count`, `tolls_amount`, 
`trip_distance`, `avg_speed`, `dropoff_time`, and `outbound`.

```{r, echo=FALSE}
r1 = regsubsets(tip_pct ~ extra + fare_amount + passenger_count + tolls_amount + 
                trip_distance + avg_speed + dropoff_time + 
                factor(dropoff_region) + outbound, data = taxi3, nvmax = 9)
r1s <- summary(r1)
r1s$which
plot(r1s$rsq, main = "R-squareds of Models with Increasingly More Variables", 
     ylab = "R-sqaured")

bestwhich <- r1s$which[which.min(r1s$cp),]
best_vars <- names(bestwhich[bestwhich == TRUE])
best_vars <- best_vars[-1]
best_vars
mbest <- lm(tip_pct ~ extra + fare_amount + tolls_amount + trip_distance + 
            outbound + dropoff_time, data = taxi3)
summary(mbest)
coef(mbest)
plot(r1, scale="Cp", main = "Key Predictors in Different Size Models")
```

The best model includes `extra`, `fare_amount`, `tolls_amount`, `trip_distance`, 
and `outbound`, as well as the Afternoon and Evening levels of `dropoff_time`
and region 6 of `dropoff_region`. We decided to drop `dropoff_region` however, 
since only 1 of 9 regions were included. Running this best regression, we get 
the following results:

`trip_distance` has the largest effect on `tip_pct`, as the data suggest that a 
rider would tip 0.414% more on a 1 mile longer trip. This is followed by 
`tolls_amount` and `fare_amount` both of which we discussed earlier.

However, even in this "best" regression, the $R^2$ value is still only 9%, 
meaning that we are only explaining 9% of the variability in `tip_pct`. This is
not bad, but in the end, we conclude that while we did gain some interesting 
insights, it is very difficult to accurately predict `tip_pct`, partly because 
there is a lot of variability, and partly because of the salience of standard 
tips like 20% and whole dollar amounts.

So, we tried one last model to predict tip, using stepwise logistic regressions 
to predict when riders tip the standard percentages and when they tip in whole
dollars.

* What affects whether or not people tip 20%?

```{r, echo = FALSE}
taxi$tip20 <- factor(ifelse(round(taxi$tip_pct) == 20, "Yes", "No"))
m20all <- glm(tip20 ~ extra + fare_amount + passenger_count + tolls_amount + 
              trip_distance + avg_speed + dropoff_time + factor(dropoff_region) 
              + outbound, data = taxi, family = binomial)
m20step <- step(m20all, direction = "backward", trace = FALSE)
summary(m20step)
```

All else equal, riders are more likely to tip 20% in the evening, and less 
likely in regions 8 and 9.

<!-- All else equal, a 1 dollar increase in fare is associated with a  -->
<!-- `exp(coef(m25step)[2])`% increase in the odds of tipping more than 25%.  -->
<!-- Similarly, a 1 dollar increase in tolls and a 1 mph increase in average speed  -->
<!-- correspond to a `exp(coef(m25step)[3])`% and `exp(coef(m25step)[4])`% increase  -->
<!-- in the odds of tipping more than 25% respectively. Finally, riders seem to be  -->
<!-- more likely to tip more than 25% in some regions as well, notably region 15.  -->


* What affects whether or not people tip at all?

```{r, echo=FALSE}
taxi$tip0 <- factor(ifelse(round(taxi$tip_pct) == 0, "Yes", "No"))
m0all <- glm(tip0 ~ extra + fare_amount + passenger_count + tolls_amount + 
             trip_distance + avg_speed + dropoff_time + factor(dropoff_region) 
             + outbound, data = taxi, family = binomial)
m0step <- step(m0all, direction = "backward", trace = FALSE)
summary(m0step)
```

Finally, looking at when riders don't tip, all else equal, riders are more 
likely to tip 0% with a higher fare, when there are more passengers in the taxi, 
at night, and in regions 6, 8, and 9, and are less likely to tip 0% if the trip 
is longer or they are heading outbound.

<!-- a 1 dollar increase  -->
<!-- in fare, an increase of 1 passenger, a 1 dollar increase in tolls, a 1 mile  -->
<!-- increase in distance, and 1 mph increase in average speed are associated with  -->
<!-- `exp(coef(m0step)[2])`%, `exp(coef(m0step)[3])`%, `exp(coef(m0step)[4])`%,  -->
<!-- `exp(coef(m0step)[5])`%, `exp(coef(m0step)[6])`% increases in the odds of  -->
<!-- tipping 0%, respectively. In addition, the data suggest that we should expect a  -->
<!-- rider at night to be `exp(coef(m0step)[8])`% more likely to tip nothing than a  -->
<!-- rider at other times of the day. -->


















**2) How do trips change with location and time of day?**

* What are the most popular pickup and drop off locations in New York? How does 
this change by time of day? Are the most popular pickup locations also the most 
popular dropoff locations?

```{r, warning = FALSE, message = FALSE, echo = FALSE, results = 'hide'}
data <- taxi 
GRID_RESOLUTION <- 40
title <-  "Add Title"
varname <-  "Variable"
N_LOCATIONS <- 5

# Select all taxi rides whose pickup was within the specified region. Stores 
# these rides to a new data frame 'pos'
pos <- filter(data, pickup_longitude < MAXLONG, pickup_longitude > MINLONG, 
              pickup_latitude < MAXLAT, pickup_latitude > MINLAT) 

# Remove all rows with dropoff longitude or latitude equal to zero
pos <- filter(pos, dropoff_longitude != 0, dropoff_latitude!= 0) 
# Remove all rows where pickup and dropoff locations are the same.
pos <- filter(pos, dropoff_longitude != pickup_longitude, 
              dropoff_latitude != pickup_latitude) 

pos$lat_region <- cut(pos$pickup_latitude,GRID_RESOLUTION) # cuts latitude into bins
pos$long_region <- cut(pos$pickup_longitude,GRID_RESOLUTION) # cuts latitude into bins

# Groups data in 'pos' by 'lat_region' and 'long_region' (region on the grid) 
# Calculates number of rides being picked up in each region ('count') and the 
# average direction traveled for each taxi rides beginning in each grid (long_dir_avg, 
# lat_dir_avg)
grouped <- group_by(pos, lat_region, long_region) %>% summarize(count = n()) 

# Create new data frame 'max' containing the regions with the most pickups
max <- grouped[order(grouped$count, decreasing =TRUE),][1:N_LOCATIONS,] 

# Create data frame of all taxi rides starting from these regions
max <- filter(pos, lat_region == max$lat_region & long_region == max$long_region) 

# Groups data by pickup_hour, latitude, and longitude and counts how many rides are in 
# each group
grouped_pickup <- group_by(max, pickup_hour, lat_region, long_region) %>% 
                    summarize(count = n()) 

# Add column identifying rides as "pickup"
grouped_pickup$type <- rep("pickup", nrow(grouped_pickup)) 
```

```{r, echo = FALSE,  results = 'hide', warning = FALSE, message = FALSE}
rm(pos, grouped, max)

# Select all taxi rides whose dropoff was within the specified region. Stores 
# these rides to a new data frame 'pos'
pos <- filter(data, dropoff_longitude < MAXLONG, dropoff_longitude > MINLONG, 
              dropoff_latitude < MAXLAT, dropoff_latitude > MINLAT) 

# Remove all rows with pickup longitude or latitude equal to zero.
pos <- filter(pos, pickup_longitude != 0, pickup_latitude!= 0) 
# Remove all rows where pickup and dropoff locations are the same.
pos <- filter(pos, dropoff_longitude != pickup_longitude, 
              dropoff_latitude != pickup_latitude) 

pos$lat_region <- cut(pos$dropoff_latitude,GRID_RESOLUTION) # cuts latitude into bins
pos$long_region <- cut(pos$dropoff_longitude,GRID_RESOLUTION) # cuts longitude into bins
      
# Group data in 'pos' by 'lat_region' and 'long_region' (i.e. by region on the 
# grid). Calculates number of rides being picked up in each region ('count') 
# and the average direction traveled for each taxi rides beginning in each grid 
# (long_dir_avg, lat_dir_avg)
grouped <- group_by(pos, lat_region, long_region) %>% summarize(count = n()) 

# Create new data frame 'max' containing the regions with the most dropoffs
max <- grouped[order(grouped$count, decreasing =TRUE),][1:N_LOCATIONS,]

# Create data frame of all taxi rides going to these region
max <- filter(pos, lat_region == max$lat_region & long_region == max$long_region) 

# Groups data by pickup_hour, latitude, and longitude and counts how many rides are in each group
grouped_dropoff <- group_by(max, pickup_hour, lat_region, long_region) %>% summarize(count = n()) 

# Identifies data as "dropoff"
grouped_dropoff$type <- rep("dropoff", nrow(grouped_dropoff)) 
```
      
      
```{r, echo = FALSE,  results = 'hide', warning = FALSE, message = FALSE}
# Combine data tables "grouped_pickup" and "grouped_dropoff" into  a new data 
# frame 'dat'
dat <- bind_rows(ungroup(grouped_pickup), ungroup(grouped_dropoff)) 

# Create data frame of latitudes and longitudes
grid <- data.frame(latitude = dat$lat_region,longitude = dat$long_region) 
grid <- unique(grid) # removes duplicates

grid$regioncode <- 1:nrow(grid) # gives each region its own integer code

# Classify rides in 'dat' by region
dat$region <- rep(NA,nrow(dat))
for(i in 1: nrow(grid)) {
  dat$region[(as.character(dat$lat_region) == as.character(grid$latitude[i])) & 
       (as.character(dat$long_region) == as.character(grid$longitude[i]))] <- i
} 

dat$region <- as.factor(dat$region)
```

```{r, echo = FALSE, results = 'hide', warning = FALSE, message = FALSE}
temp <-  grid$latitude
temp <- gsub("\\(", "", temp)
temp <- gsub("\\]", "", temp)
temp <- strsplit(temp, ",")

# Split region boundaries from 'cut()' into upper and lower latitudes
temp <- unlist(temp)
temp <- as.numeric(temp)
grid$max_lat <- temp[2*1:nrow(grid)] # list of latitude upper bounds
grid$min_lat <- temp[2*1:nrow(grid)-1] # list of latitude lower bounds
grid$avg_lat <- 0.5*(grid$max_lat + grid$min_lat) # list of average region latitudes
    
temp <-  grid$longitude # stores longitude bounds of regions to 'temp'
temp <- gsub("\\(", "", temp)
temp <- gsub("\\]", "", temp)
temp <- strsplit(temp, ",")

# Split region boundaries from 'cut()' into upper and lower longitudes
temp <- unlist(temp)
temp <- as.numeric(temp)
grid$max_long <- temp[2*1:nrow(grid)] # list of latitude upper bounds
grid$min_long <- temp[2*1:nrow(grid)-1] # list of latitude lower bounds
grid$avg_long <- 0.5*(grid$max_long + grid$min_long) # list of average region longitudes
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
timeplot <- ggplot(data = dat, aes(x = pickup_hour, y = count, col = region)) +
  geom_line(size = 1) +
  labs(title = "Analysis of 5 Most Popular Pickup and Dropoff Sites", 
       x = expression(italic("Hour of Day")), 
       y = expression(italic("Number of Rides"))) + 
  facet_wrap(~ type, ncol =1)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
MAXLAT1 <- 40.775
MINLAT1 <- 40.74
MAXLONG1 <- -73.965
MINLONG1<- -73.995
map <- get_map(location = c(MINLONG1 - 0.01 ,MINLAT1 - 0.01, MAXLONG1 + 0.01, 
                     MAXLAT1 + 0.01), source = "google", maptype = "roadmap") 

pop_map <- ggmap(map) +
  labs(x = expression(italic("Longitude")~"(degrees)"),
       y = expression(italic("Latitude")~"(degrees)")) +
  geom_label(aes(jitter(avg_long), jitter(avg_lat),label = regioncode), 
             data = grid, size = 2) + 
  theme(axis.line = element_blank(), 
    axis.text.x = element_blank(), 
    axis.text.y = element_blank(),
    axis.ticks = element_blank(), 
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(),plot.margin=unit(c(0,0,0,0),"mm")) +
  scale_y_continuous(limits=c(MINLAT1, MAXLAT1)) + 
  scale_x_continuous(limits = c(MINLONG1, MAXLONG1))
```

```{r, warning = FALSE, message = FALSE, fig.width = 5, fig.height= 3}
grid.arrange(timeplot, pop_map, ncol = 2, widths = c(2,1))
```
Regions 1-5 are the most popular taxi pickup sites (1 = most popular, 5 = least). 
egions 6-10 are the most popular dropoff sites. Dropoff sites tend be most 
active at 7-8 AM. Pickup sites are most active at 8-9 PM. We will next 
investigate how popular pickup sites rank in terms of dropoff sites and vice 
versa.
  
* Which directions are taxis traveling on average at different times of the day? 
```{r, warning = FALSE, message = FALSE, echo = FALSE, results = 'hide'}
# Remove rows with abnormal dropoff longitudes
rm(pos, grouped)
MAXLAT <- 40.85
MINLAT <- 40.675
MAXLONG <- -73.85
MINLONG <- -74.1
SIZEFACTOR  <-  0.015 # Desired Magnitude of Direction Arrows
GRID_RESOLUTION <- 25

pos$lat_region <- cut(pos$pickup_latitude,GRID_RESOLUTION) # cuts latitude into bins
pos$long_region <- cut(pos$pickup_longitude,GRID_RESOLUTION) # cuts latitude into bin
```

```{r, echo = FALSE, results = 'hide', warning = FALSE, message = FALSE}
# Add rows 'lat_dir' and 'long_dir' to the data frame 'pos' which respectively 
# contain the change in latitude and longitude for each ride.
pos <- mutate(pos, lat_dir = (dropoff_latitude - pickup_latitude), 
              long_dir = (dropoff_longitude - pickup_longitude)) 

# Create columns 'lat_dir_scaled' and 'long_dir_scaled', which contain the 
# coordinates of 'lat_dir' and 'long_dir' normalized so that the direction 
# vector has magnitude equal to 'SIZEFACTOR'
pos <- mutate(pos, lat_dir_scaled = lat_dir * SIZEFACTOR/sqrt(lat_dir^2 + long_dir^2), 
              long_dir_scaled = long_dir * SIZEFACTOR /sqrt(lat_dir^2 + long_dir^2)) 

# Note: NaN results for rides where pickup and dropoff locations are equal.

pos$daytime <- rep(NA, nrow(pos))

# Create new column of pos indicating whether pickup-time was in the morning or evening
pos$daytime <- ifelse(pos$pickup_hour < 12, "morning", "evening") 
pos$daytime <- factor(pos$daytime, levels= c("morning","evening"))
```

```{r,warning = FALSE, message = FALSE, echo = FALSE, results = 'hide'}
# Groups data in 'pos' by 'lat_region' and 'long_region' (i.e. by region on the 
# grid). Calculates number of rides being picked up in each region ('count') and 
# the average direction traveled for each taxi rides beginning in each grid 
# (long_dir_avg, lat_dir_avg)
grouped <- group_by(pos, lat_region, long_region, daytime) %>% 
  summarize(lat_dir_avg = mean(lat_dir_scaled, na.rm = TRUE), 
            long_dir_avg = mean(long_dir_scaled, na.rm =TRUE), count = n()) 

temp <-  grouped$lat_region 
temp <- gsub("\\(", "", temp)
temp <- gsub("\\]", "", temp)
temp <- strsplit(temp, ",")
temp <- unlist(temp)
temp <- as.numeric(temp)
grouped$max_lat <- temp[2*1:nrow(grouped)] # list of latitude upper bounds
grouped$min_lat <- temp[2*1:nrow(grouped)-1] # list of latitude lower bounds
grouped$avg_lat <- 0.5*(grouped$max_lat + grouped$min_lat) # list of average latitude
    
temp <-  grouped$long_region
temp <- gsub("\\(", "", temp)
temp <- gsub("\\]", "", temp)
temp <- strsplit(temp, ",")
temp <- unlist(temp)
temp <- as.numeric(temp)
grouped$max_long <- temp[2*1:nrow(grouped)] # list of latitude upper bounds
grouped$min_long <- temp[2*1:nrow(grouped)-1] # list of latitude lower bounds
grouped$avg_long <- 0.5*(grouped$max_long + grouped$min_long) # list of average longitude
```

```{r, warning = FALSE, message = FALSE, echo = FALSE, results = 'hide'}
heatplot <- ggplot(data = grouped, aes(xmin = min_long, xmax = max_long, 
                   ymin = min_lat, ymax = max_lat, fill = count)) + 
  geom_rect() + 
  scale_fill_gradientn("Number of Pickups", 
                       colors = c("purple","blue","green","yellow", "orange", "red")) + 
  facet_wrap(~daytime)
```

```{r, warning = FALSE, message = FALSE, echo=FALSE, fig.width = 9, fig.height= 3}
MAXLAT1 <- 40.8
MINLAT1 <- 40.7
MAXLONG1 <- -73.92
MINLONG1<- -74.03
MINRIDES <-  30 # minimum number of rides for arrow to show up

map <- get_map(location = c(MINLONG, MINLAT, MAXLONG, MAXLAT), source = "stamen", 
               maptype = "watercolor", color = "bw")
```

```{r, warning = FALSE, message = FALSE, fig.width = 5.5, fig.height= 3}
ggmap(map) + geom_segment(aes(x = avg_long, xend = (avg_long + long_dir_avg), y = avg_lat, yend = (avg_lat + lat_dir_avg), color = count), data = filter(grouped, count > MINRIDES), arrow = arrow(length=unit(0.15, "cm"), ends="first", type = "closed"), size = 0.9) + labs(title = "Direction of Motion by Region", x = expression(italic("Longitude")~"(degrees)"), y = expression(italic("Latitude")~"(degrees)")) + scale_color_gradientn("Number of Rides", colors = c("purple","blue","green","yellow","orange","red")) + facet_wrap( ~ daytime) + scale_y_continuous(limits=c(MINLAT1, MAXLAT1)) + scale_x_continuous(limits = c(MINLONG1, MAXLONG1))
```
There is a general outward flux of taxis. Taxi rides starting farther from 
center tend to agree more on the outward direction (longer arrows). We will 
facet into more time catagories. We might investigate where outward directed 
taxis are going

* What is the average speed of taxis depending on the time of day and region of 
the city?
To do this, we would create a heat map of Manhattan where different colors 
indicate different travel speeds of taxis.


## Code Appendix

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}

```
